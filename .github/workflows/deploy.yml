# name: Build and Push Docker Image

# on:
#   push:
#     branches: [main]

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#     - name: ðŸ“¥ Checkout code
#       uses: actions/checkout@v3

#     - name: ðŸ›  Set up Docker Buildx
#       uses: docker/setup-buildx-action@v3

#     - name: ðŸ§± Build Docker Image
#       run: |
#         docker build -t helloapp:latest .

#     - name: ðŸ“¦ Save Docker image as tar file
#       run: |
#         docker save helloapp:latest -o helloapp.tar

#     - name: â¬†ï¸ Upload Docker image as artifact
#       uses: actions/upload-artifact@v4
#       with:
#         name: helloapp-image
#         path: helloapp.tar

#   push:
#     runs-on: ubuntu-latest
#     needs: build

#     steps:
#     - name: ðŸ“¥ Checkout code
#       uses: actions/checkout@v3

#     - name: â¬‡ï¸ Download Docker image artifact
#       uses: actions/download-artifact@v4
#       with:
#         name: helloapp-image

#     - name: ðŸ“¦ Load Docker image from tar
#       run: docker load -i helloapp.tar

#     - name: ðŸ” Login to DockerHub
#       run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

#     - name: ðŸ·ï¸ Tag and Push Docker Image
#       run: |
#         docker tag helloapp:latest ${{ secrets.DOCKER_USERNAME }}/helloappshubham:latest
#         docker push ${{ secrets.DOCKER_USERNAME }}/helloappshubham:latest


name: Docker Build and Push Workflow

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image-name: ${{ steps.set-output.outputs.image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/helloappshubham:latest .

      - name: Save image name for next job
        id: set-output
        run: echo "image=${{ secrets.DOCKER_USERNAME }}/helloappshubham:latest" >> $GITHUB_OUTPUT

  push:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Login to DockerHub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      - name: Push Docker Image to DockerHub
        run: docker push ${{ secrets.DOCKER_USERNAME }}/helloappshubham:latest
